<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restauracja - Lista Zamówień</title>
    <link rel="stylesheet" href="/przepisy.css">
</head>
<body>
    <div class="przepisy-container">
        <h1>Lista Zamówień</h1>
        <ul id="recipeList" class="recipe-list"></ul>
        <div id="result">Wybierz danie, aby zobaczyć przepis.</div>
    </div>
    <button class="back-btn" onclick="window.location.href='/'">Wróć</button>
    <script>
        const resultDiv = document.getElementById('result');
        const recipeList = document.getElementById('recipeList');
        const wsHost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' ? 'localhost' : '192.168.1.10';
        const socket = new WebSocket(`ws://${wsHost}:5000/ws`);
        let dishes = JSON.parse(localStorage.getItem('orders') || '[]');

        function updateRecipeList() {
            recipeList.innerHTML = '';
            if (dishes.length === 0) {
                recipeList.innerHTML = '<li>Brak zamówień</li>';
                resultDiv.innerHTML = 'Wybierz danie, aby zobaczyć przepis.';
                return;
            }
            dishes.forEach((dish, index) => {
                let checked = false;
                const li = document.createElement('li');
                const dishSpan = document.createElement('span');
                dishSpan.className = 'dish-name';
                dishSpan.textContent = dish;
                dishSpan.onclick = () => {
                    checked = !checked;
                    if (checked) {
                        fetchRecipe(dish);
                    } else {
                        hideRecipe();
                    }
                };
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Usuń';
                deleteBtn.onclick = () => deleteDish(index);
                li.appendChild(dishSpan);
                li.appendChild(deleteBtn);
                recipeList.appendChild(li);
            });
        }

        function deleteDish(index) {
            dishes.splice(index, 1);
            localStorage.setItem('orders', JSON.stringify(dishes));
            updateRecipeList();
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'orders', orders: dishes }));
                console.log('Sent updated orders via WebSocket:', dishes);
            }
        }

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'dishName') {
                    dishes.push(data.dishName);
                    localStorage.setItem('orders', JSON.stringify(dishes));
                    updateRecipeList();
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'orders', orders: dishes }));
                    }
                }
                // Ignore 'recipe' messages to prevent automatic display
            } catch (e) {
                console.error('Error parsing WebSocket message:', e);
            }
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        socket.onopen = () => {
            console.log('WebSocket connection established');
        };

        async function fetchRecipe(dishName) {
            try {
                const response = await fetch(`/api/controlling/recepie/${encodeURIComponent(dishName)}`);
                if (!response.ok) throw new Error('Brak przepisu');
                const recipe = await response.json();
                resultDiv.innerHTML = `
                    <p><strong>Składniki:</strong> ${recipe.ingredients}</p>
                    <p><strong>Instrukcje:</strong> ${recipe.instructions}</p>
                `;
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ type: 'recipe', recipe }));
                }
            } catch (error) {
                console.error('Error fetching recipe:', error);
                resultDiv.innerHTML = `<p>${error.message}</p>`;
            }
        }

        function hideRecipe() {
            resultDiv.innerHTML = 'Wybierz danie, aby zobaczyć przepis.';
        }

        // Initialize list on page load
        updateRecipeList();
    </script>
</body>
</html>